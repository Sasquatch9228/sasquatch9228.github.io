<!DOCTYPE html>
<html>
    <head>
        <title>Unbricking - Chrome OS Exploits</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="google-site-verification" content="GO1Hg4RaaWS5e6glGz85VfK_r_UflKBPw8aXRIG22WA" />
        <link rel="icon" href="../../assets/icon.png">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Google+Sans">
        <link rel="stylesheet" href="../../main.css">
        <link rel="stylesheet" href="../detail.css">
        <script src="../addheader.js"></script>
        <script>
            window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
            ga('create', 'UA-XXXXX-Y', 'auto');
            ga('send', 'pageview');
        </script>
    </head>
    <body>
        <div id="main-content">
            <h3>
                <span class="title">Unbricking</span>
                <br>
                <small>MrChromebox</small>
                <p>
                <a href="https://wiki.mrchromebox.tech/Unbricking" target="_blank">
                    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-link flex-shrink-0 mr-2">
                        <path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path>
                    </svg>
                    Website
                </a>
                <a href="https://discord.com/channels/419123358698045453/1042626210448023665" target="_blank">
                    <svg style="color: rgb(0, 0, 0);" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-discord" viewBox="0 0 16 16">
                        <path d="M13.545 2.907a13.227 13.227 0 0 0-3.257-1.011.05.05 0 0 0-.052.025c-.141.25-.297.577-.406.833a12.19 12.19 0 0 0-3.658 0 8.258 8.258 0 0 0-.412-.833.051.051 0 0 0-.052-.025c-1.125.194-2.22.534-3.257 1.011a.041.041 0 0 0-.021.018C.356 6.024-.213 9.047.066 12.032c.001.014.01.028.021.037a13.276 13.276 0 0 0 3.995 2.02.05.05 0 0 0 .056-.019c.308-.42.582-.863.818-1.329a.05.05 0 0 0-.01-.059.051.051 0 0 0-.018-.011 8.875 8.875 0 0 1-1.248-.595.05.05 0 0 1-.02-.066.051.051 0 0 1 .015-.019c.084-.063.168-.129.248-.195a.05.05 0 0 1 .051-.007c2.619 1.196 5.454 1.196 8.041 0a.052.052 0 0 1 .053.007c.08.066.164.132.248.195a.051.051 0 0 1-.004.085 8.254 8.254 0 0 1-1.249.594.05.05 0 0 0-.03.03.052.052 0 0 0 .003.041c.24.465.515.909.817 1.329a.05.05 0 0 0 .056.019 13.235 13.235 0 0 0 4.001-2.02.049.049 0 0 0 .021-.037c.334-3.451-.559-6.449-2.366-9.106a.034.034 0 0 0-.02-.019Zm-8.198 7.307c-.789 0-1.438-.724-1.438-1.612 0-.889.637-1.613 1.438-1.613.807 0 1.45.73 1.438 1.613 0 .888-.637 1.612-1.438 1.612Zm5.316 0c-.788 0-1.438-.724-1.438-1.612 0-.889.637-1.613 1.438-1.613.807 0 1.451.73 1.438 1.613 0 .888-.631 1.612-1.438 1.612Z" fill="#000000"></path>
                    </svg>
                    Discord
                </a>
            </h3>
            <div class="warning">This can severely and dangerously harm your Chromebook if done incorrectly. Perform this exploit at your very own risk.</div>
            <p>
            Fixing a Chromebook bricked system with hardware disassembly and external devices.
            <h3>Flashing/Unbricking with a CH341a USB programmer</h3>
            <div class="requirements">
                <h3>Requirements</h3>
                <li>A ChromeOS device with a SOIC-8 type SPI flash chip. Most Chromebooks released before 2018 use this type of chip, but there are a few notable exceptions:
- Google Chromebook Pixel 2013
- Google Chromebook Pixel 2015
- HP Chromebook 13 G1
- Asus Chromebook C302SA</li>
              <p>
              <strong>These devices all use a WSON-8 flash chip, which does not expose the pins of the chip, so they cannot easily be "clipped" like a SOIC-8 chip. While it is usually possible to modify a SOIC-8 chip clip to attach to a WSON-8 chip, it's less than ideal. Both Chromebook Pixels feature a Google debug header, which can connect to a debug servo with a special cable and be flashed that way, but not an option for most users (I however do have access to one, and can unbrick Chromebook Pixels for any users upon request).</strong>  
              </p>
            </div>
            <ol>
                <h3>Instructions</h3>
                <h4>Hardware Disassembly</h4>
                <p>
                While this is somewhat device-specific, the main points are the same:
                </p>
                <li>Disconnect all external power
Remove bottom cover (screws are often located under rubber feet or strips)
Disconnect the internal battery (for Chromeboxes, disconnect the small CMOS battery)
Locate the SPI flash chip</li>
              <p>
              Most ChromeOS devices use a Winbond flash chip, though some use a compatible chip from another manufacturer, eg Gigadevices. It will be either an 8MB or 16MB chip, with the identifier W25Q64[xx] (8MB) or W25Q128[xx] (16MB) where [xx] is usually FV or DV. We do not want to touch the EC firmware chip, which is identified by W25X40[xx].
              Unfortunately, many devices have the flash chip located on the top side of the main board, and require fully removing the main board in order to flash. This is true for most Baytrail and Braswell models.  
              </p>
              <p>
              Pin 1 of the flash chip will be notated by a dot/depression on the chip; be sure to align this with pin 1 on the chip clip wiring (a red strip on the example linked above).  
              </p>
              <p>
              Googling should locate a disassembly guide for most models. If you can't find one for your exact model, try to find one for another model of the same manufacturer as the bottom cover removal tends to be very similar.
              </p>
              <details>
                <summary><u>Preparing to flash</u></summary>
                <p>
                Once you have your device disassembled and flash chip located, time to boot up the flashing environment. Most any Linux setup should do as long as either flashrom is available from the distro's software repositories, or it's 64-bit x86 (in which case you can download a statically compiled build of flashrom from my site). This guide will use a Ubuntu 23.04 live session booted from USB.
                </p>
                <p>
                <strong>So let's get to it:</strong>
                </p>
                <li>Boot your Linux environment (Ubuntu 2304 live USB or later recommended)
Connect to WiFi/internet
Open a (non-root) terminal/shell window, change to home directory</li>
                <p>
                <code>cd;</code>
                </p>
                <li>
                <strong>Install flashrom via apt:</strong>
                </li>
                <p>
                <code>sudo apt update<br>sudo apt install flashrom</code>
                </p>
                <li>
                <strong>Assemble CH341a programmer, 1.8v adapter (if needed), and chip clip/wiring. Ensure that pin 1 is correct and consistent.</strong>
                </li>
                <p>
                <img alt="Ch341a annotated.png" src="./images/Ch341a_annotated.png" width="500" height="205">
                </p>
                <li>
                <strong>Connect the chip clip to the SPI flash chip, then connect the CH341a to the Linux host machine. Note the dot/depression indicating pin 1.</strong>
                </li>
                <p>
                <img alt="SOIC-8 chip.jpg" src="./images/SOIC-8_chip.jpg" width="500" height="444"/>
                </p>
                <li>
                <strong>Test connectivity and ensure the flash chip is properly identified:</strong>
                </li>
                <p>
                <code>sudo flashrom -p ch341a_spi</code>      
                </p>
                <li>
                Flashrom will produce output identifying the flash chip. If it doesn't, double check your connections to the programmer and the chip clip and retry.
                </li>
                <p>
                <img alt="Flashrom chip detect.png" src="./images/Flashrom_chip_detect.png" width="500" height="271"/>
                </p>
                <li>
                <strong>Determine file to be flashed</strong>
                </li>
                <p>
                If you were flashing the UEFI firmware when things went sideways, then that's the easiest way to proceed.  You can download the UEFI firmware for your device by examining 
                <a rel="nofollow" class="external text" href="https://github.com/MrChromebox/scripts/blob/master/sources.sh">the sources.sh file from the Firmware Utility Script GitGub repository</a>.
                Simply concatenate the device-specific filename to the Full ROM base path:
                </p>
                <p>
                <code>wget <Full ROM base path><device specific filename></code>
                </p>
                <li>
                eg for the Acer Chromebook 14 CB3-431 (EDGAR)
                </li>
                <p>
                <code>wget https://mrchromebox.tech/files/firmware/full_rom/coreboot_tiano-edgar-mrchromebox_20180827.rom</code>
                </p>
                <li>
                Don't forget to get the sha1 file for verification:
                </li>
                <p>
                <code>wget https://mrchromebox.tech/files/firmware/full_rom/coreboot_tiano-edgar-mrchromebox_20180827.rom.sha1</code>
                </p>
                <li>
                Then verify the download:
                </li>
                <p>
                <code>sha1sum -c coreboot_tiano-edgar-mrchromebox_20180827.rom.sha1</code>
                </p>
                <li>
                - The shellball firmware for the device
                As with the UEFI firmware above, the shellball rom can be downloaded by concatenating the shellball base path with the device-specific filename:
                </li>
                <p>
                <code>wget <shellball base path>/shellball.<device name>.bin</code>
                </p>
                <li>
                eg for the Acer Chromebook 14 CB3-431 (EDGAR):
                </li>
                <p>
                <code>wget https://mrchromebox.tech/files/firmware/shellball/shellball.edgar.bin</code>
                </p>
                <p>
                If you're not sure which file to use for your device / don't know your device's board name, you can reference:
                <br/>
                https://mrchromebox.tech/#devices and/or https://www.chromium.org/chromium-os/developer-information-for-chrome-os-devices.
                </p>
                </details>
                <details>
                <summary><u>Persisting the board's Vital Product Data (VPD)</u></summary>
                <p>
                The firmware in all ChromeOS devices contains a section (RO_VPD) which stores board-specific data, like the serial number, localization settings, and on many devices which have an Ethernet port, the LAN MAC address as well. When flashing via the Firmware Utility Script, the script will automatically extract this from the running firmware and inject it into the firmware to be flashed, so the device serial, LAN MAC address, etc are all maintained. Without this, the device will use a default/generic LAN MAC address set by coreboot. While not ideal, this is only really an issue if two or more of the same device are on the same LAN segment (or you're statically assigning IP addresses based on MAC). But for completeness, if flashing the UEFI firmware or shellball ROM, we'll extract the VPD (either from the board itself or a backup made by the script) and inject it into the firmware to be flashed.
                </p>
                <li>
                <strong>IMPORTANT NOTE:</strong> you don't need to do this if flashing a stock firmware backup created by the Firmware Utility Script; that image already contains the VPD.
                </li>
                <li>
                For both the options below, we'll need to use the cbfstool (coreboot filesystem) binary, so let's download/extract that:
                </li>
                <p>
                <code>wget https://mrchromebox.tech/files/util/cbfstool.tar.gz && tar -zxf cbfstool.tar.gz</code>
                </p>
                <li>
                <strong>Option 1: extract VPD from the firmware on device:</strong>
                </li>
                <p>
                <code>sudo flashrom -p ch341a_spi -r badflash.rom<br>./cbfstool badflash.rom read -r RO_VPD -f vpd.bin</code>
                </p>
                <li>
                <strong>Option 2: extract VPD from stock firmware backup created by Firmware Utility Script (this assumes the file has been copied into working directory):</strong>
                </li>
                <p>
                <code>./cbfstool stock-firmware-<devicename>-<date>.rom read -r RO_VPD -f vpd.bin</code>
                </p>
                <li>
                <strong>Then we inject the VPD into the firmware image to be flashed.</strong>
                </li>
                <p>
                <code>./cbfstool <Shellball ROM/UEFI Full ROM filename> write -r RO_VPD -f vpd.bin</code>
                </p>
                <li>
                Now the firmware image is ready to be flashed, and will maintain the device's unique serial, LAN MAC address, etc.
                </li>
                </details>
                 <details>
                <summary><u>Flashing your device</u></summary>
                <p>
                Now that everything is prepared, time to flash the device. To be thorough, we'll perform a 2nd verification after flashing to ensure the integrity of the flashed firmware.
                </p>
                <li>
                <strong>Flash the firmware:</strong>
                </li>
                <p>
                If flashing your own backup created by the Firmware Utility Script (or any backup made from a live system), use:
                </p>
                <p>
                <code>sudo flashrom -p ch341a_spi --ifd -i bios -w <filename></code>
                </p>
                <p>
                or otherwise use:
                </p>
                <p>
                <code>sudo flashrom -p ch341a_spi -w <filename></code>
                </p>
                <p>
                Where <filename> is the name of your backup file, UEFI firmware file, or shellball firmware file. This will usually take 30 seconds to 90 seconds to complete; flashrom will first read the flash chip, determine which sectors differ, erase those sectors, write the new data, then verify the data written.
                </p>
                <li>
                <strong>Verify the firmware:</strong>
                </li>
                <p>
                Even though flashrom does this as part of the write process, verifying the entire flash chip is quick and an easy way to ensure everything went as it should:
                As before, if flashing your own backup created by the Firmware Utility Script (or any backup made from a live system), use:
                </p>
                <p>
                <code>sudo flashrom -p ch341a_spi --ifd -i bios -v <filename></code>
                </p>
                <p>
                or otherwise use:
                </p>
                <p>
                <code>sudo flashrom -p ch341a_spi -v <filename></code>
                </p>
                <p>
                using the same filename as before. If the verification passes, then disconnect the CH341a from the host machine, and then remove the chip clip.
                </p>
                 </details>
                <h5>Cleaning Up</h5>
                <p>
                Reassembly is the reverse of disassembly. Reconnect the internal battery and replace the bottom cover. Flip over the device, connect the external power, press the power button, and cross your fingers :)
                </p>
            </ol>
            <h3>Flashing/Unbricking with a Suzy-Q cable</h3>
            <div class="requirements">
                <h3>Requirements</h3>
                <li></li>
            </div>
            <ol>
                <h3>Instructions</h3>
                <li>Step 1</li>
                <li>Step 2</li>
                <li>Step 3</li>
            </ol>
        </div>
    </body>
</html>
